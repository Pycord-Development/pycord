name: Docs JSON Export

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  export-docs-json:
    name: Export docs.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v5
        id: setup-python
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: "requirements/docs.txt"
          check-latest: true
      - name: Install dependencies
        id: install-deps
        run: |
          python -m pip install -U pip
          pip install ".[docs]"
          pip install beautifulsoup4
      - name: Build Sphinx HTML docs
        id: build-sphinx
        run: sphinx-build -b html docs docs/_build/html
      - name: Export docs.json
        id: generate-json
        run: python scripts/docs_json_exporter.py
      - name: Upload docs.json as artifact
        uses: actions/upload-artifact@v4.6.2
        id: artifact-upload
        with:
          name: Pycord Docs JSON
          path: docs.json
          retention-days: 1
      - name: Show docs.json summary
        run: |
          head -n 40 docs.json || tail -n 40 docs.json
      - name: Output artifact ID
        run:  |
          echo "artifact-id=${{ steps.artifact-upload.outputs.artifact-id }}" >> $GITHUB_OUTPUT
          echo "artifact-url=${{ steps.artifact-upload.outputs.artifact-url }}" >> $GITHUB_OUTPUT
          echo "::notice::Artifact uploaded: ${{ steps.artifact-upload.outputs.artifact-url }}"
